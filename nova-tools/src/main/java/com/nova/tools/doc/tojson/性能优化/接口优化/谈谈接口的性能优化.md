                                  高频面试题：谈谈接口的性能优化
### 1. Mysql
1.1 没加索引
> 起初数据量小，没体现，业务发展起来越来越慢

1.2 索引失效
> explain sql语句，查看type（连接类型）、key（实际用到的索引）、key_len（实际索引长度）  
> （1）不满足最左前缀原则  
> （2）范围索引列没有放到最后  
> （3）使用了select * from   
> （4）索引列上有计算  
> （5）索引列上使用了函数  
> （6）字符类型没加引号  
> （7）用is null和is not null没注意字段是否允许为空  
> （8）like查询左边有%  
> （9）使用or关键字时没有注意%  

1.3 选错索引
> 有时候mysql会走错索引，必要时可以使用force index强制查询sql走某个索引

1.4 sql优化
> （1）用union all代替union  
> （2）避免使用select * from      
> （3）小表驱动大表   
> （4）批量操作    
> （5）多用limit  
> （6）in中值太多  
> （7）增量查询  
> （8）高效的分页   
> （9）用链接查询代替子查询  
> （10）join表不宜太多  
> （11）控制索引的数量  
> （12）选择合理的字段类型  
> （13）提升group by的效率  
> （14）索引优化  

1.4 数据库分布式锁  
行锁 > 间隙锁 > 表锁

1.5 分库分表  
分库：解决数据库连接资源不足、磁盘IO的新能瓶颈问题  
分表：解决单表数据量太大（阿里规约单表数据大于500w建议分表）、sql查询即使有索引仍耗时，此外还可以解决消耗cpu资源问题

### 2. 接口
2.1 远程调用  
多个调用接口数据进行合并处理，串行修改并行（java8的completableFuture、countDownLatch）

2.2 缓存  
添加redis缓存、二级缓存（hashMap、guava、caffeine）  

二级缓存需要考虑数据不一致的问题  

2.3 重复调用  
for循环查询数据库，改成根据ids in查询list  

2.4 死循环需要注意  
~~~java
while (ture) {
    if(condition){
        break;
    }
}
~~~

2.5 慎用递归  
设置好递归深度  

2.6 异步处理  
例如：登录接口需要写登录流水、通知信息，这些异步处理（多线程、mq）

2.7 避免大实物  
@Transactional注解减少代码量但是可以造成一下问题  
> （1）导致死锁 
> （2）锁等待       
> （3）回滚时间长   
> （4）接口超时    
> （5）并发情况下数据库连接池被占满  
> （6）数据库主从延迟  

如何优化呢？
> （1）将查询方法（select）放到实物外面
> （2）事物中避免远程调用       
> （3）事物中避免一次性处理太多数据   
> （4）接口超时    
> （5）有些功能可以非事物执行或异步执行  

2.7 锁粒度  
单节点：synchronized，如果锁加的粒度太粗，导致性能降低  
分布式：redisson

2.8 分页优化  
深分页，最好每次查询返回的结果带着id，下次请求时sql判断，如果lastId不是空，id > params.lastId


### 3. 辅助功能
3.1 打开慢sql记录log

3.2 系统监控Prometheus，它提供了接口响应、三方耗时、cpu、磁盘
* [系统监控Prometheus](https://rnhmht0gb6.feishu.cn/docx/JdFMdY6ssoFJaIxvhGgcJ705nBc)
